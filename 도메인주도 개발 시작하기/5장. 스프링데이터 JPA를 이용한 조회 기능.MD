  


### 5.1 시작에 앞서  
  
**CQRS?**  
명령모델과 조회 모델을 분리하는 패턴이다. 명령 모델은 상태를 변경하는 기능을 구현할 때 사용하고, 조회 모델은 데이터를 조회하는 기능을 구현할 때 사용한다.  
  


### 5.2 검색을 위한 스펙  
  
검색 조건을 다양하게 조합해야 하는 경우, 우리가 사용할 수 있는 방법은 스펙(specification)이다. 스펙은 애그리거트가 특정 조건을 충족하는 지를 검사할 때 사용하는 인터페이스다. 스펙 인터페이스는 다음과 같이 정의한다.  
```java
    public interface Specification<T> {
        public boolean isSatisfiedBy(T agg);
    }
```  
리포지터리나 DAO는 검색 대상을 필터링하는 용도로 스펙을 사용한다.  
```java
    public class MemoryRepository implements OrderRepository{

        public List<Order> findAll(Specification<Order> spec) {
            List<Order> allOrders = findAll();
            return allOrders.stream()
                            .filter(order -> spec.isSatisfied(order))
                            .toList();
        }
    }
```  
  
하지만 모든 애그리거트 객체를 메모리에 보관하기도 어렵고, 조회 성능에 문제가 발생하기 때문에 실제 스펙은 이렇게 구현하지 않아도 된다.  
  


### 5.3 스프링 데이터 JPA를 이용한 스펙 구현  
  
엔티티 타입이 OrderSummary 이고, ordererId 프로퍼티 값이 지정한 값과 동일하다는 전제로 스펙 인터페이스 클래스를 구현해 보면 아래와 같다.  
```java
    public class OrdererIdSpec implements Specification<OrderSummary> {
        private String ordererId;

        public OrdererIdSpec(String oredererId) {
            this.ordererId = ordererId;
        }

        @Override
        public Predicate toPredicate(Root<OrderSummary> root, CriteriaQuery<?> query, CriteriaBuilder cb) {
            return cb.equal(root.get(OrderSummary_.odererId), ordererId);
        }
    }
```  
OrderSummary_ 클래스는 JPA 정적 메타 모델을 정의한 클래스이다. 정적 메타 모델 클래스는 대상 모델의 각 프로퍼티와 동일한 이름을 갖는 정적 필드를 정의한다. 문자열은 오타 가능성이 있고, 디버깅하기 어려운 이유로 Criteria를 사용할 때에는 정적 메타 모델 클래스를 사용하는 것이 코드 안정성과 생산성 측에서 유리하다. 이 클래스는 dto 패키지 안에 존재한다.  
  
스펙 구현 클래스를 개별적으로 만들지 않고 별도 클래스에 스펙 생성 기능을 모으는 방법도 있다.  
```java
    public class OrderSummarySpecs{
        public static Specification<OrderSummary> ordererId(String ordereId) {
            return (Root<OrderSummary> root, CriteriaQuery<?> query, CriteriaBuilder cb) -> cb.equal(root.<String>get("ordererId"), odererId);
        }

        public static Specification<OrderSummary> orderDateBetween(LocalDate from, LocalDate to) {
            return (Root<OrderSummary> root, CriteriaQuery<?> query, CriteriaBuilder cb) -> cb.between(root.get(OrderSummary_.orderDate), from, to);
        }
    }
```
스펙 인터페이스는 함수형 인터페이스이므로, 람다식을 이용해 더 간결하게 객체를 생성할 수 있다.   
  


### 5.4 리포지터리/DAO에서 스펙 사용하기  